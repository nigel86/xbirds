var w=Object.defineProperty;var A=(o,t,r)=>t in o?w(o,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):o[t]=r;var h=(o,t,r)=>(A(o,typeof t!="symbol"?t+"":t,r),r);import{ag as k,ah as v,ai as N,o as f,T as C,aj as L,ak as E,al as U,E as P,am as T,an as I}from"./index-9tT2V643.js";function g(o,t){return k(o.abi,t,o.extensions)}function y(o,t){return o in t.readContract.functions}class F{constructor(t,r,a){h(this,"featureName",v.name);h(this,"set",f(async t=>{const r=await this._parseAndUploadMetadata(t),a=this.contractWrapper;if(this.supportsContractMetadata(a))return C.fromContractWrapper({contractWrapper:this.contractWrapper,method:"setContractURI",args:[r],parse:e=>({receipt:e,data:this.get})});throw new L(v)}));h(this,"update",f(async t=>await this.set.prepare({...await this.get(),...t})));this.contractWrapper=t,this.schema=r,this.storage=a}parseOutputMetadata(t){return this.schema.output.parseAsync(t)}parseInputMetadata(t){return this.schema.input.parseAsync(t)}async get(){let t;if(this.supportsContractMetadata(this.contractWrapper)){const r=await this.contractWrapper.read("contractURI",[]);r&&r.includes("://")&&(t=await this.storage.downloadJSON(r))}if(!t)try{let r;try{y("name",this.contractWrapper)&&(r=await this.contractWrapper.read("name",[]))}catch{}let a;try{y("symbol",this.contractWrapper)&&(a=await this.contractWrapper.read("symbol",[]))}catch{}let e;try{e=await N(this.contractWrapper.address,this.contractWrapper.getProvider(),this.storage,this.contractWrapper.options)}catch{}t={name:r||(e==null?void 0:e.name),symbol:a,description:e==null?void 0:e.info.title}}catch{throw new Error("Could not fetch contract metadata")}return this.parseOutputMetadata(t)}async _parseAndUploadMetadata(t){const r=await this.parseInputMetadata(t);return this.storage.upload(r)}supportsContractMetadata(t){return g(t,"ContractMetadata")}}class G{constructor(t){this.contractWrapper=t}addTransactionListener(t){this.contractWrapper.addListener(E.Transaction,t)}removeTransactionListener(t){this.contractWrapper.off(E.Transaction,t)}addEventListener(t,r){const a=this.contractWrapper.readContract.interface.getEvent(t),s={address:this.contractWrapper.address,topics:[this.contractWrapper.readContract.interface.getEventTopic(a)]},n=i=>{const c=this.contractWrapper.readContract.interface.parseLog(i);r(this.toContractEvent(c.eventFragment,c.args,i))};return this.contractWrapper.getProvider().on(s,n),()=>{this.contractWrapper.getProvider().off(s,n)}}listenToAllEvents(t){const a={address:this.contractWrapper.address},e=s=>{try{const n=this.contractWrapper.readContract.interface.parseLog(s);t(this.toContractEvent(n.eventFragment,n.args,s))}catch(n){console.error("Could not parse event:",s,n)}};return this.contractWrapper.getProvider().on(a,e),()=>{this.contractWrapper.getProvider().off(a,e)}}removeEventListener(t,r){const a=this.contractWrapper.readContract.interface.getEvent(t);this.contractWrapper.readContract.off(a.name,r)}removeAllListeners(){this.contractWrapper.readContract.removeAllListeners();const r={address:this.contractWrapper.address};this.contractWrapper.getProvider().removeAllListeners(r)}async getAllEvents(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{fromBlock:0,toBlock:"latest",order:"desc"};const a=(await this.contractWrapper.readContract.queryFilter({},t.fromBlock,t.toBlock)).sort((e,s)=>t.order==="desc"?s.blockNumber-e.blockNumber:e.blockNumber-s.blockNumber);return this.parseEvents(a)}async getEvents(t){let r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{fromBlock:0,toBlock:"latest",order:"desc"};const a=this.contractWrapper.readContract.interface.getEvent(t),e=r.filters?a.inputs.map(c=>r.filters[c.name]):[],s=this.contractWrapper.readContract.filters[a.name](...e),i=(await this.contractWrapper.readContract.queryFilter(s,r.fromBlock,r.toBlock)).sort((c,d)=>r.order==="desc"?d.blockNumber-c.blockNumber:c.blockNumber-d.blockNumber);return this.parseEvents(i)}parseEvents(t){return t.map(r=>{const a=Object.fromEntries(Object.entries(r).filter(e=>typeof e[1]!="function"&&e[0]!=="args"));if(r.args){const e=Object.entries(r.args),s=e.slice(e.length/2,e.length),n={};for(const[i,c]of s)n[i]=c;return{eventName:r.event||"",data:n,transaction:a}}return{eventName:r.event||"",data:{},transaction:a}})}toContractEvent(t,r,a){const e=Object.fromEntries(Object.entries(a).filter(n=>typeof n[1]!="function"&&n[0]!=="args")),s={};return t.inputs.forEach((n,i)=>{if(Array.isArray(r[i])){const c=n.components;if(c){const d=r[i];if(n.type==="tuple[]"){const u=[];for(let p=0;p<d.length;p++){const m=d[p],W={};for(let l=0;l<c.length;l++){const b=c[l].name;W[b]=m[l]}u.push(W)}s[n.name]=u}else{const u={};for(let p=0;p<c.length;p++){const m=c[p].name;u[m]=d[p]}s[n.name]=u}}}else s[n.name]=r[i]}),{eventName:t.name,data:s,transaction:e}}}class O{constructor(t){this.contractWrapper=t}async gasCostOf(t,r){const[a,e]=await Promise.all([this.contractWrapper.getProvider().getGasPrice(),this.contractWrapper.estimateGas(t,r)]);return U(e.mul(a))}async gasLimitOf(t,r){return this.contractWrapper.estimateGas(t,r)}async currentGasPriceInGwei(){const t=await this.contractWrapper.getProvider().getGasPrice();return P(t,"gwei")}}class R{constructor(t,r,a){h(this,"featureName",T.name);h(this,"set",f(async t=>g(this.contractWrapper,"AppURI")?C.fromContractWrapper({contractWrapper:this.contractWrapper,method:"setAppURI",args:[t]}):await this.metadata.update.prepare({app_uri:t})));this.contractWrapper=t,this.metadata=r,this.storage=a}async get(){return g(this.contractWrapper,"AppURI")?await this.contractWrapper.read("appURI",[]):I((await this.metadata.get()).app_uri||"",this.storage.getGatewayUrls())}}export{F as C,O as G,R as a,G as b,g as d,y as h};
